# Latency Matrix - Merged Cells Display

## 概述

改进了延迟矩阵的显示格式，实现了合并单元格效果，使得表格更加清晰易读，特别是在每个主机有多个HCA时。

## 新旧格式对比

### 旧格式（原始实现）

```
┌──────────────────┬──────────────┬──────────────┬──────────────┬──────────────┐
│ Source → Target  │ host1:mlx5_0 │ host1:mlx5_1 │ host2:mlx5_0 │ host2:mlx5_1 │
├──────────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│ host1:mlx5_0     │      - μs    │    1.23 μs   │    1.45 μs   │    1.50 μs   │
│ host1:mlx5_1     │    1.24 μs   │      - μs    │    1.46 μs   │    1.51 μs   │
│ host2:mlx5_0     │    1.47 μs   │    1.48 μs   │      - μs    │    1.25 μs   │
│ host2:mlx5_1     │    1.49 μs   │    1.50 μs   │    1.26 μs   │      - μs    │
└──────────────────┴──────────────┴──────────────┴──────────────┴──────────────┘
```

**问题**：
- 主机名和HCA名称混在一起（`host1:mlx5_0`）
- 难以快速识别哪些HCA属于同一主机
- 列标题重复显示主机名
- 表格宽度随着HCA数量增加而快速增长

### 新格式（合并单元格）

```
┌────────────┬────────────┬─────────────────────────────┬─────────────────────────────┐
│            │            │ host1                       │ host2                       │
│            │            ├──────────────┬──────────────┼──────────────┬──────────────┤
│            │            │ mlx5_0       │ mlx5_1       │ mlx5_0       │ mlx5_1       │
├────────────┼────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│ host1      │ mlx5_0     │            - │      1.23 μs │      1.45 μs │      1.50 μs │
│            ├────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│            │ mlx5_1     │      1.24 μs │            - │      1.46 μs │      1.51 μs │
├────────────┼────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│ host2      │ mlx5_0     │      1.47 μs │      1.48 μs │            - │      1.25 μs │
│            ├────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│            │ mlx5_1     │      1.49 μs │      1.50 μs │      1.26 μs │            - │
└────────────┴────────────┴──────────────┴──────────────┴──────────────┴──────────────┘
```

**优势**：
- ✅ 主机名和HCA名称分开显示，层次清晰
- ✅ 同一主机的多个HCA通过合并单元格直观展示
- ✅ 列标题也采用分层结构（主机名 + HCA名）
- ✅ 更容易识别跨主机和同主机内的延迟差异
- ✅ 表格结构更加规整，视觉效果更好

## 技术实现

### 表格结构

表格分为两个部分：

#### 1. 顶部标题（2行）
- **第1行**：目标主机名
  - 每个主机占据其所有HCA列的宽度
  - 相同主机名的列通过合并显示
- **第2行**：目标HCA名称
  - 每个HCA独立一列
  - 按主机分组排列

#### 2. 左侧标题（2列）
- **第1列**：源主机名
  - 每个主机占据其所有HCA行的高度
  - 相同主机名的行通过空格表示合并
- **第2列**：源HCA名称
  - 每个HCA独立一行
  - 按主机分组排列

### 分隔线规则

1. **主机之间的分隔线**：完全穿过所有列，包括主机名列
   ```
   ├────────────┼────────────┼──────────────┼──────────────┤
   ```

2. **同主机内HCA之间的分隔线**：不穿过主机名列（留空）
   ```
   │            ├────────────┼──────────────┼──────────────┤
   ```

### 列宽计算

| 列类型 | 最小宽度 | 最大宽度 | 说明 |
|--------|----------|----------|------|
| 主机名列 | 10 | 20 | 适应最长主机名 |
| HCA列 | 10 | 15 | 适应最长HCA名 |
| 延迟值列 | 12 | 12 | 固定宽度，容纳 "123.45 μs" |

### 数据结构

```go
// 按主机组织HCA
sourceHostHCAs := make(map[string][]string) // host -> []hca
targetHostHCAs := make(map[string][]string) // host -> []hca

// 延迟矩阵
matrix := make(map[string]map[string]float64) // "host:hca" -> "host:hca" -> latency
```

### 排序规则

1. 主机名按字母顺序排序
2. 每个主机内的HCA按字母顺序排序
3. 保证表格显示的一致性和可预测性

## 使用示例

### 单HCA场景（3个主机）

```
┌────────────┬────────────┬──────────────┬──────────────┬──────────────┐
│            │            │ host1        │ host2        │ host3        │
│            │            ├──────────────┼──────────────┼──────────────┤
│            │            │ mlx5_0       │ mlx5_0       │ mlx5_0       │
├────────────┼────────────┼──────────────┼──────────────┼──────────────┤
│ host1      │ mlx5_0     │            - │      1.45 μs │      1.52 μs │
├────────────┼────────────┼──────────────┼──────────────┼──────────────┤
│ host2      │ mlx5_0     │      1.46 μs │            - │      1.50 μs │
├────────────┼────────────┼──────────────┼──────────────┼──────────────┤
│ host3      │ mlx5_0     │      1.53 μs │      1.51 μs │            - │
└────────────┴────────────┴──────────────┴──────────────┴──────────────┘
```

### 多HCA场景（2个主机，每个3个HCA）

```
┌────────────┬────────────┬────────────────────────────────────────────┬────────────────────────────────────────────┐
│            │            │ host1                                      │ host2                                      │
│            │            ├──────────────┬──────────────┬──────────────┼──────────────┬──────────────┬──────────────┤
│            │            │ mlx5_0       │ mlx5_1       │ mlx5_2       │ mlx5_0       │ mlx5_1       │ mlx5_2       │
├────────────┼────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│ host1      │ mlx5_0     │            - │      1.10 μs │      1.12 μs │      1.45 μs │      1.50 μs │      1.48 μs │
│            ├────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│            │ mlx5_1     │      1.11 μs │            - │      1.13 μs │      1.46 μs │      1.51 μs │      1.49 μs │
│            ├────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│            │ mlx5_2     │      1.12 μs │      1.14 μs │            - │      1.47 μs │      1.52 μs │      1.50 μs │
├────────────┼────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│ host2      │ mlx5_0     │      1.48 μs │      1.49 μs │      1.50 μs │            - │      1.20 μs │      1.22 μs │
│            ├────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│            │ mlx5_1     │      1.49 μs │      1.50 μs │      1.51 μs │      1.21 μs │            - │      1.23 μs │
│            ├────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│            │ mlx5_2     │      1.50 μs │      1.51 μs │      1.52 μs │      1.22 μs │      1.24 μs │            - │
└────────────┴────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┘
```

## 边界情况处理

### 长主机名截断
如果主机名超过最大宽度（20字符），会自动截断并添加".."：
```
very-long-hostnam..
```

### 长HCA名称截断
如果HCA名称超过最大宽度（15字符），会自动截断并添加".."：
```
very-long-hca-..
```

### 单一测量
即使只有一个测量值，也会显示完整的表格结构：
```
┌────────────┬────────────┬──────────────┐
│            │            │ host2        │
│            │            ├──────────────┤
│            │            │ mlx5_0       │
├────────────┼────────────┼──────────────┤
│ host1      │ mlx5_0     │      1.50 μs │
└────────────┴────────────┴──────────────┘
```

### 空数据
如果没有数据，显示警告信息：
```
⚠️  No latency data to display
```

## 性能优化

1. **预计算列数**：避免重复计算总列数
2. **动态列宽**：根据实际数据调整列宽，避免浪费空间
3. **高效排序**：主机和HCA分别排序，减少比较次数
4. **字符串构建器**：使用 `strings.Repeat()` 高效生成边框字符

## 测试覆盖

单元测试覆盖了以下场景：
- ✅ 空数据
- ✅ 单一测量值
- ✅ 多个测量值
- ✅ 完整的N×N矩阵
- ✅ 长主机名处理
- ✅ 混合长短名称
- ✅ **多HCA合并单元格效果**

## 向后兼容性

- ✅ 数据结构不变，仅改变显示格式
- ✅ 统计信息保持不变
- ✅ 与现有的 `lat` 命令工作流完全兼容

## 未来增强

1. **颜色编码**：根据延迟值使用颜色标记（绿色=低，黄色=中，红色=高）
2. **导出格式**：支持导出为CSV、HTML等格式，方便进一步分析
3. **阈值告警**：当延迟超过阈值时高亮显示
4. **对比模式**：并排显示两次测试的结果进行对比
5. **热力图**：使用ASCII字符绘制延迟热力图

## 相关文件

- `cmd/lat.go` - `displayLatencyMatrix()` 函数实现
- `cmd/lat_test.go` - 单元测试
- `docs/latency-filename-fix.md` - 文件名格式说明
- `docs/latency-probe-implementation.md` - 进程监控实现
