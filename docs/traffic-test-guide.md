# 流量测试使用指南

## 概述

流量测试功能提供了一键式自动化网络性能测试流程，无需手动执行多个命令行步骤。

## 前置条件

### 1. 环境准备
- 所有测试主机已配置 SSH 免密登录
- InfiniBand 驱动和工具已安装
- `ib_write_bw` 工具可用
- 配置文件中 `report.enable` 设置为 `true`

### 2. 配置文件
确保配置文件包含以下必要信息：
- `server.hostname`: 服务端主机列表
- `client.hostname`: 客户端主机列表
- `server.hca_name` / `client.hca_name`: HCA 设备名称
- `stream_type`: 测试模式 (fullmesh/incast/p2p)
- `speed`: 理论带宽值（用于对比）

## 使用步骤

### 步骤 1: 启动服务器
```bash
cd build
./xnetperf server --port 8080
```

### 步骤 2: 打开 Web 界面
在浏览器中访问: `http://localhost:8080`

### 步骤 3: 切换到流量测试页面
点击顶部的 **"流量测试"** 标签页

### 步骤 4: 选择配置文件
从下拉框中选择要使用的配置文件

### 步骤 5: 开始测试
点击 **"开始测试"** 按钮

## 工作流程说明

测试会自动执行以下 5 个步骤：

### 1. PreCheck 检查 (约 10-30秒)
- **目的**: 验证所有 HCA 状态正常
- **检查项**: 
  - Link 状态 (LinkUp)
  - 端口状态 (ACTIVE)
  - 网络速度一致性
  - 固件版本
  - 主板 ID
- **失败处理**: 发现错误或警告时停止执行

### 2. 运行测试 (约 5-10秒)
- **目的**: 分发并启动测试脚本
- **操作**:
  - 清理远程主机上的旧报告文件
  - 生成测试脚本（根据 stream_type）
  - 通过 SSH 分发脚本到各主机
  - 启动 ib_write_bw 进程
- **失败处理**: 脚本分发或启动失败时停止

### 3. 探测状态 (时间取决于测试时长)
- **目的**: 监控测试进程执行状态
- **操作**:
  - 每 2 秒查询一次所有主机的进程状态
  - 实时显示运行中/完成/错误的主机数量
  - 等待所有进程完成（最长 10 分钟）
- **显示信息**:
  - 运行中主机数
  - 已完成主机数
  - 错误主机数
  - 总进程数
- **超时处理**: 超过 10 分钟仍未完成会显示警告，但继续执行后续步骤

### 4. 收集报告 (约 10-30秒)
- **目的**: 从各主机收集测试结果文件
- **操作**:
  - 通过 SCP 收集 JSON 格式的报告文件
  - 按主机分目录保存到本地 `reports/` 目录
- **显示信息**: 每个主机收集的文件数量
- **失败处理**: 部分文件收集失败会显示警告，但不会停止

### 5. 生成报告 (约 1-5秒)
- **目的**: 分析性能数据，生成统计报告
- **支持模式**:
  - **FullMesh / InCast**: 客户端-服务端模式分析
  - **P2P**: 点对点模式分析
- **显示内容**: 见下文"报告解读"

## 报告解读

### FullMesh / InCast 模式报告

#### 1. 带宽汇总
- **服务端总带宽**: 所有服务端 HCA 的理论带宽之和
- **客户端数量**: 所有客户端 HCA 的数量
- **理论单客户端带宽**: 服务端总带宽 ÷ 客户端数量

#### 2. 客户端数据表 (TX)
| 列名 | 说明 | 正常范围 |
|-----|------|---------|
| 主机名 | 客户端主机 | - |
| 设备 | HCA 设备名 | - |
| 实际带宽 | 测试得到的发送带宽 | - |
| 理论带宽 | 预期的单客户端带宽 | - |
| 差值 | 实际 - 理论 | 接近 0 |
| 差值百分比 | (实际 - 理论) / 理论 × 100% | -20% ~ +20% |
| 状态 | OK / NOT OK | OK 为正常 |

**状态判断规则**:
- 差值百分比在 -20% ~ +20% 之间: **OK** (绿色)
- 差值百分比超出范围: **NOT OK** (红色)

#### 3. 服务端数据表 (RX)
| 列名 | 说明 |
|-----|------|
| 主机名 | 服务端主机 |
| 设备 | HCA 设备名 |
| 接收带宽 | 累计接收到的带宽 |

### P2P 模式报告

#### 1. 汇总统计
- **总连接对数**: 测试的主机-设备对数量
- **平均速度**: 所有连接的平均带宽

#### 2. 详细数据表
| 列名 | 说明 |
|-----|------|
| 主机名 | 主机名称 |
| 设备 | HCA 设备名 |
| 平均速度 | 该设备的平均带宽 |
| 连接数 | 该设备建立的连接数 |

## 界面说明

### 进度条
显示整体执行进度：
- 0%: 待开始
- 20%: PreCheck 阶段
- 40%: Run 阶段
- 60%: Probe 阶段
- 80%: Collect 阶段
- 90%: Report 阶段
- 100%: 完成

### 步骤状态
每个步骤的状态图标和徽章：
- ⏰ 待执行 (灰色): 步骤尚未开始
- 🔵 执行中 (蓝色): 步骤正在执行
- ✅ 成功 (绿色): 步骤执行成功
- ⚠️ 警告 (橙色): 步骤有警告但继续
- ❌ 失败 (红色): 步骤执行失败

### 按钮
- **开始测试**: 启动完整的自动化流程
- **重置**: 清除当前测试结果，返回初始状态

## 常见问题

### Q1: PreCheck 失败怎么办？
**A**: 
1. 查看 PreCheck 结果中具体哪些 HCA 状态异常
2. 登录到对应主机检查 InfiniBand 状态：
   ```bash
   ibstat
   ibstatus
   ```
3. 确认链路连接正常，端口状态为 ACTIVE
4. 修复问题后重新测试

### Q2: Probe 阶段一直显示运行中？
**A**:
1. 检查测试脚本是否正常启动：
   ```bash
   ssh <hostname> "ps aux | grep ib_write_bw"
   ```
2. 查看远程主机的测试日志
3. 如果确认测试已经完成但未检测到，可能是进程名称匹配问题
4. 最长会等待 10 分钟，超时后会继续执行后续步骤

### Q3: 收集报告失败？
**A**:
1. 确认 SSH 免密登录配置正确
2. 确认远程主机的 `report.dir` 目录存在
3. 检查是否有 JSON 报告文件生成：
   ```bash
   ssh <hostname> "ls -la <report.dir>/*.json"
   ```
4. 确认 SCP 权限正常

### Q4: 报告数据为空或异常？
**A**:
1. 检查 `reports/` 目录下是否有 JSON 文件
2. 验证 JSON 文件格式是否正确
3. 确认配置文件的 `stream_type` 设置正确
4. 查看浏览器控制台是否有错误信息

### Q5: 差值百分比很大怎么办？
**A**:
1. **正常情况**: 差值在 ±20% 以内
2. **异常情况**: 
   - 检查网络拓扑是否符合测试模式（FullMesh/InCast）
   - 确认理论带宽 `speed` 设置是否正确
   - 查看是否有网络丢包或拥塞
   - 验证 HCA 配置是否一致

## 性能优化建议

### 1. 测试参数调整
在配置文件中可以调整以下参数以优化测试：

```yaml
perftest:
  duration: 10          # 测试持续时间（秒）
  size: 65536          # 数据包大小
  qp_num: 1            # Queue Pair 数量
  
report:
  dir: /tmp/reports    # 报告保存目录
  enable: true         # 启用报告生成
```

### 2. 并发控制
- FullMesh 模式下，主机数量过多会导致大量并发连接
- 建议分批测试或使用 InCast 模式

### 3. 超时设置
- Probe 阶段默认最长等待 10 分钟
- 如果测试时间很长，建议增加 `duration` 但缩短单次测试范围

## 高级用法

### 1. 仅执行某个步骤
虽然 Web 界面是自动化流程，但如果需要单独执行某步，可以使用命令行：

```bash
# 仅 PreCheck
./xnetperf precheck -c config.yaml

# 仅运行测试
./xnetperf run -c config.yaml

# 仅探测
./xnetperf probe -c config.yaml

# 仅收集
./xnetperf collect -c config.yaml

# 仅分析
./xnetperf analyze -c config.yaml
```

### 2. 导出报告
报告数据通过 API 返回 JSON 格式，可以：
- 在浏览器开发者工具中查看原始数据
- 使用脚本调用 API 自动化获取报告
- 后续版本会支持 PDF/Excel 导出

### 3. 历史报告查看
当前版本在 `reports/` 目录下保存了所有收集的 JSON 文件，可以：
- 手动备份这些文件用于历史对比
- 使用 `analyze` 命令重新分析旧数据

## 安全注意事项

1. **SSH 密钥管理**: 确保 SSH 私钥安全，定期轮换
2. **网络隔离**: 建议在独立的测试网络中运行
3. **访问控制**: 考虑为 Web 界面添加认证（后续版本）
4. **数据清理**: 定期清理 `reports/` 目录下的旧报告

## 技术支持

如果遇到问题：
1. 查看浏览器控制台错误信息
2. 查看服务器日志输出
3. 使用命令行工具单步调试
4. 参考 `docs/` 目录下的其他文档

---

**文档版本**: 1.0  
**适用版本**: xnetperf v0.1.1+  
**最后更新**: 2025-10-14
