# Web UI 改进总结 - v0.0.8

## 版本号：v0.0.8

## 改进内容

### 1. 统一使用 snake_case 命名规范

#### 问题
之前 API 返回的 JSON 使用 PascalCase（如 `StartPort`），导致前后端字段名不一致，增加了维护复杂度。

#### 解决方案
在 Go 结构体中添加 `json` 标签，统一使用 snake_case：

**修改文件**: `config/config.go`

```go
type Config struct {
    StartPort          int     `yaml:"start_port" json:"start_port"`
    StreamType         string  `yaml:"stream_type" json:"stream_type"`
    QpNum              int     `yaml:"qp_num" json:"qp_num"`
    // ... 所有字段都添加了 json 标签
}

type Report struct {
    Enable bool   `yaml:"enable" json:"enable"`
    Dir    string `yaml:"dir" json:"dir"`
}

type Run struct {
    Infinitely      bool `yaml:"infinitely" json:"infinitely"`
    DurationSeconds int  `yaml:"duration_seconds" json:"duration_seconds"`
}

type ServerConfig struct {
    Hostname []string `yaml:"hostname" json:"hostname"`
    Hca      []string `yaml:"hca" json:"hca"`
}

type ClientConfig struct {
    Hostname []string `yaml:"hostname" json:"hostname"`
    Hca      []string `yaml:"hca" json:"hca"`
}
```

#### 效果
- **API 响应格式**（GET）：
```json
{
  "code": 0,
  "data": {
    "start_port": 20000,
    "stream_type": "incast",
    "qp_num": 10,
    "server": {
      "hostname": ["server1"],
      "hca": ["mlx5_0"]
    }
  }
}
```

- **前端代码简化**：
```javascript
// 之前需要转换 PascalCase
data.StartPort → data.start_port
data.Server.Hostname → data.server.hostname

// 现在完全一致
data.start_port ✅
data.server.hostname ✅
```

### 2. 添加配置文件预览功能

#### 功能描述
在编辑配置时，可以实时预览生成的 YAML 格式配置文件内容。

#### 实现
- 添加"👁️ 预览"按钮
- 实现 YAML 格式转换函数 `toYAML()`
- 使用模态框显示预览内容
- 支持语法高亮显示

#### 使用方法
1. 在配置编辑页面，点击右上角"👁️ 预览"按钮
2. 弹出预览窗口，显示当前配置的 YAML 格式
3. 预览内容实时反映当前表单数据
4. 点击"关闭"按钮退出预览

#### 代码实现

**HTML** (`web/static/index.html`):
```html
<!-- 预览按钮 -->
<button class="btn btn-default" onclick="app.previewConfig()">
    👁️ 预览
</button>

<!-- 预览模态框 -->
<div id="previewModal" class="modal">
    <div class="modal-content preview-content">
        <div class="modal-header">配置文件预览</div>
        <div class="modal-body">
            <pre id="previewCode" class="preview-code"></pre>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="app.hidePreviewDialog()">关闭</button>
        </div>
    </div>
</div>
```

**JavaScript** (`web/static/app.js`):
```javascript
// 预览配置
previewConfig() {
    if (!this.currentConfig) return;
    
    const data = this.collectFormData();
    const yaml = this.toYAML(data);
    
    document.getElementById('previewCode').textContent = yaml;
    document.getElementById('previewModal').classList.add('show');
}

// YAML 转换函数
toYAML(obj, indent = 0) {
    const spaces = '    '.repeat(indent);
    let yaml = '';
    
    for (const [key, value] of Object.entries(obj)) {
        if (value === null || value === undefined) continue;
        
        if (typeof value === 'object' && !Array.isArray(value)) {
            yaml += `${spaces}${key}:\n`;
            yaml += this.toYAML(value, indent + 1);
        } else if (Array.isArray(value)) {
            yaml += `${spaces}${key}:\n`;
            if (value.length === 0) {
                yaml += `${spaces}    []\n`;
            } else {
                value.forEach(item => {
                    yaml += `${spaces}    - ${item}\n`;
                });
            }
        } else {
            yaml += `${spaces}${key}: ${value}\n`;
        }
    }
    
    return yaml;
}
```

### 3. 代码重构和简化

#### addTag() 和 removeTag() 简化
之前需要手动转换 snake_case 到 PascalCase，现在直接使用：

```javascript
// 之前（复杂）
addTag(type, value) {
    const [sectionLower, fieldLower] = type.split('_');
    const section = sectionLower.charAt(0).toUpperCase() + sectionLower.slice(1);
    const field = fieldLower.charAt(0).toUpperCase() + fieldLower.slice(1);
    this.formData[section][field].push(value);
}

// 现在（简单）
addTag(type, value) {
    const [section, field] = type.split('_');
    this.formData[section][field].push(value);
}
```

## 测试验证

### 1. 测试 snake_case 统一
```bash
# 测试 API 返回格式
curl http://localhost:8080/api/configs/a.yaml | jq '.data | keys'

# 应该看到 snake_case 字段名
[
  "client",
  "message_size_bytes",
  "output_base",
  "qp_num",
  "rdma_cm",
  "report",
  "run",
  "server",
  "speed",
  "start_port",
  "stream_type",
  "waiting_time_seconds"
]
```

### 2. 测试预览功能
1. 访问 http://localhost:8080
2. 选择或创建配置
3. 填写表单字段
4. 点击"👁️ 预览"
5. 验证 YAML 格式正确
6. 验证数组字段显示正确（如 server.hostname）

### 3. 测试完整流程
1. 创建新配置
2. 填写所有字段（包括数组字段）
3. 预览配置
4. 保存配置
5. 重新加载配置
6. 验证所有字段正确显示

## 相关文件

### 后端
- `config/config.go` - 添加 JSON 标签

### 前端
- `web/static/index.html` - 添加预览按钮和模态框
- `web/static/app.js` - 实现预览功能和简化代码

## API 变更

无 API 端点变更，仅响应格式变更：

**之前**:
```json
{
  "data": {
    "StartPort": 20000,
    "Server": {"Hostname": []}
  }
}
```

**现在**:
```json
{
  "data": {
    "start_port": 20000,
    "server": {"hostname": []}
  }
}
```

## 升级说明

1. 重新编译：`go build -o build/xnetperf`
2. 重启服务器：`./xnetperf server --port 8080`
3. 强制刷新浏览器缓存（Ctrl+Shift+R）
4. 所有功能正常工作

## 注意事项

- 确保清除浏览器缓存，否则可能加载旧的 JavaScript 代码
- YAML 预览是客户端生成的，不会与服务器通信
- 预览功能支持实时查看当前表单状态，无需保存
