# Latency Probe Implementation

## æ¦‚è¿°

å®ç°äº† `execLatencyProbeCommand` å‡½æ•°ï¼Œç”¨äºç›‘æ§ `ib_write_lat` è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚è¿™ä¸ªåŠŸèƒ½ä¸ç°æœ‰çš„ `probe` å‘½ä»¤ç±»ä¼¼ï¼Œä½†ä¸“é—¨ç”¨äºå»¶è¿Ÿæµ‹è¯•ã€‚

## å®ç°çš„åŠŸèƒ½

### 1. execLatencyProbeCommand

**ä½ç½®**: `cmd/lat.go`

**åŠŸèƒ½**: ç›‘æ§æ‰€æœ‰é…ç½®çš„ä¸»æœºä¸Šçš„ `ib_write_lat` è¿›ç¨‹

**ç‰¹æ€§**:
- è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰é…ç½®çš„ä¸»æœºï¼ˆserverå’Œclientï¼‰
- æ¯5ç§’è½®è¯¢ä¸€æ¬¡è¿›ç¨‹çŠ¶æ€
- æ˜¾ç¤ºå®æ—¶è¿›ç¨‹ç»Ÿè®¡ä¿¡æ¯
- å½“æ‰€æœ‰è¿›ç¨‹å®Œæˆåè‡ªåŠ¨é€€å‡º
- ä½¿ç”¨å¹¶å‘æ–¹å¼åŒæ—¶æ£€æŸ¥æ‰€æœ‰ä¸»æœº

### 2. è¾…åŠ©å‡½æ•°

#### probeLatencyAllHosts
```go
func probeLatencyAllHosts(hosts map[string]bool, sshKeyPath string) []LatencyProbeResult
```
- å¹¶å‘æ¢æµ‹æ‰€æœ‰ä¸»æœº
- ä½¿ç”¨ `sync.WaitGroup` ç­‰å¾…æ‰€æœ‰å¹¶å‘ä»»åŠ¡å®Œæˆ
- ä½¿ç”¨ `sync.Mutex` ä¿æŠ¤å…±äº«ç»“æœåˆ‡ç‰‡

#### probeLatencyHost
```go
func probeLatencyHost(hostname, sshKeyPath string) LatencyProbeResult
```
- é€šè¿‡SSHæ‰§è¡Œ `ps aux | grep ib_write_lat | grep -v grep`
- è§£æå‘½ä»¤è¾“å‡ºï¼Œç»Ÿè®¡è¿›ç¨‹æ•°é‡
- å¤„ç†ä¸‰ç§çŠ¶æ€ï¼š
  - `RUNNING`: æœ‰è¿›ç¨‹åœ¨è¿è¡Œ
  - `COMPLETED`: æ‰€æœ‰è¿›ç¨‹å·²å®Œæˆ
  - `ERROR`: SSHè¿æ¥æˆ–æ‰§è¡Œå¤±è´¥

#### displayLatencyProbeResults
```go
func displayLatencyProbeResults(results []LatencyProbeResult)
```
- ä½¿ç”¨è¡¨æ ¼æ ¼å¼æ˜¾ç¤ºæ¢æµ‹ç»“æœ
- æ˜¾ç¤ºæ¯ä¸ªä¸»æœºçš„çŠ¶æ€ã€è¿›ç¨‹æ•°é‡å’Œè¯¦ç»†ä¿¡æ¯
- æä¾›æ€»ä½“æ‘˜è¦ç»Ÿè®¡ä¿¡æ¯

### 3. æ•°æ®ç»“æ„

#### LatencyProbeResult
```go
type LatencyProbeResult struct {
    Hostname     string   // ä¸»æœºå
    ProcessCount int      // è¿›ç¨‹æ•°é‡
    Processes    []string // è¿›ç¨‹åˆ—è¡¨
    Error        string   // é”™è¯¯ä¿¡æ¯
    Status       string   // çŠ¶æ€: RUNNING/COMPLETED/ERROR
}
```

## è¾“å‡ºç¤ºä¾‹

```
Probing ib_write_lat processes on 3 hosts...
Mode: Continuous monitoring until all processes complete

=== Latency Probe Results (14:23:45) ===
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hostname            â”‚ Status        â”‚ Process Countâ”‚ Details         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ host1               â”‚ ğŸŸ¡ RUNNING    â”‚            8 â”‚ 8 process(es)   â”‚
â”‚ host2               â”‚ ğŸŸ¡ RUNNING    â”‚            8 â”‚ 8 process(es)   â”‚
â”‚ host3               â”‚ ğŸŸ¡ RUNNING    â”‚            8 â”‚ 8 process(es)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Summary: 3 hosts running (24 processes), 0 completed, 0 errors
Waiting 5 seconds for next probe...

=== Latency Probe Results (14:23:50) ===
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hostname            â”‚ Status        â”‚ Process Countâ”‚ Details         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ host1               â”‚ âœ… COMPLETED  â”‚            0 â”‚ No processes    â”‚
â”‚ host2               â”‚ âœ… COMPLETED  â”‚            0 â”‚ No processes    â”‚
â”‚ host3               â”‚ âœ… COMPLETED  â”‚            0 â”‚ No processes    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Summary: 0 hosts running (0 processes), 3 completed, 0 errors
âœ… All ib_write_lat processes have completed!
```

## ä½¿ç”¨åœºæ™¯

åœ¨ `lat` å‘½ä»¤çš„å·¥ä½œæµç¨‹ä¸­ï¼Œæ­¥éª¤3ï¼ˆè¿è¡Œè„šæœ¬ï¼‰å¯åŠ¨æ‰€æœ‰ `ib_write_lat` è¿›ç¨‹åï¼Œæ­¥éª¤4ä¼šè‡ªåŠ¨è°ƒç”¨æ­¤å‡½æ•°è¿›è¡Œç›‘æ§ï¼š

```
Step 0: Precheck - Verify HCA health
Step 1: Generate Scripts - Creating latency test scripts
Step 2: Clear Report Directory
Step 3: Execute Scripts - Running latency tests
Step 4: Monitor Processes - Probing ib_write_lat processes  â† è¿™é‡Œä½¿ç”¨
Step 5: Analyze Reports - Building NÃ—N latency matrix
```

## å®ç°å‚è€ƒ

æ­¤å®ç°å‚è€ƒäº†ç°æœ‰çš„ `probe` å‘½ä»¤ï¼ˆ`cmd/probe.go`ï¼‰ï¼Œä½†åšäº†ä»¥ä¸‹è°ƒæ•´ï¼š

1. **è¿›ç¨‹åç§°**: ç›‘æ§ `ib_write_lat` è€Œä¸æ˜¯ `ib_write_bw`
2. **è½®è¯¢é—´éš”**: å›ºå®šä¸º5ç§’ï¼ˆprobeå‘½ä»¤å¯é…ç½®ï¼‰
3. **è¿è¡Œæ¨¡å¼**: å§‹ç»ˆä¸ºè¿ç»­ç›‘æ§æ¨¡å¼ï¼ˆprobeå‘½ä»¤æ”¯æŒä¸€æ¬¡æ€§æ¨¡å¼ï¼‰
4. **é›†æˆæ–¹å¼**: ä½œä¸º `lat` å‘½ä»¤å·¥ä½œæµçš„ä¸€éƒ¨åˆ†è‡ªåŠ¨æ‰§è¡Œ

## ä»£ç è´¨é‡

- âœ… æ— ç¼–è¯‘é”™è¯¯
- âœ… æ— lintè­¦å‘Š
- âœ… æ·»åŠ äº†å¿…è¦çš„å¯¼å…¥ï¼ˆ`sync`, `time`ï¼‰
- âœ… éµå¾ªGoç¼–ç è§„èŒƒ
- âœ… ä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

## æœªæ¥ä¼˜åŒ–å»ºè®®

1. **å¯é…ç½®è½®è¯¢é—´éš”**: å…è®¸ç”¨æˆ·è‡ªå®šä¹‰è½®è¯¢é¢‘ç‡
2. **è¿›ç¨‹è¯¦æƒ…æ˜¾ç¤º**: å¯é€‰æ‹©æ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ï¼ˆPIDã€ç«¯å£ç­‰ï¼‰
3. **è¶…æ—¶æœºåˆ¶**: æ·»åŠ æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œé˜²æ­¢æ°¸ä¹…é˜»å¡
4. **æ€§èƒ½ä¼˜åŒ–**: å¯¹äºå¤§è§„æ¨¡é›†ç¾¤ï¼Œå¯ä»¥æ‰¹é‡å¤„ç†ä¸»æœº
5. **æ—¥å¿—è®°å½•**: å°†æ¢æµ‹å†å²è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶

## ç›¸å…³æ–‡ä»¶

- `cmd/lat.go` - ä¸»å®ç°æ–‡ä»¶
- `cmd/probe.go` - å‚è€ƒå®ç°ï¼ˆbandwidthæ¢æµ‹ï¼‰
- `stream/stream_latency.go` - è„šæœ¬ç”Ÿæˆé€»è¾‘
