# v0.1.2 SSH Private Key Implementation

## 需求
支持自定义 SSH 私钥路径，因为有些机器使用的不是默认的 `~/.ssh/id_rsa`

## Implementation Status

### ✅ Completed

1. **config/config.go** - SSH configuration structure
   - Added `SSH` struct with `PrivateKey` field
   - Updated `Config` struct to include `SSH` field
   - Updated `NewDefaultConfig()` to set default SSH key path
   - Updated `ApplyDefaults()` to handle SSH defaults

2. **stream/command_builder.go** - Command builder SSH support
   - Added `sshPrivateKey` field to `IBWriteBWCommandBuilder`
   - Added `SSHPrivateKey()` method for setting the SSH key
   - Updated `String()` method to include `-i` parameter when SSH key is specified

3. **stream/stream_*.go** - Stream generation files
   - Updated `stream_incast.go` to use `.SSHPrivateKey(cfg.SSH.PrivateKey)`
   - Updated `stream_p2p.go` to use `.SSHPrivateKey(cfg.SSH.PrivateKey)`
   - Updated `stream_fullmesh.go` to use `.SSHPrivateKey(cfg.SSH.PrivateKey)`

4. **cmd/precheck.go** - PreCheck command
   - Added `buildSSHCommand()` helper function
   - Updated `precheckHCA()` to accept `sshKeyPath` parameter
   - Updated `precheckAllHCAs()` to accept `sshKeyPath` parameter
   - Replaced all `exec.Command("ssh")` calls with `buildSSHCommand()`

5. **cmd/probe.go** - Probe command
   - Updated `probeHost()` to accept `sshKeyPath` parameter
   - Updated `probeAllHosts()` to accept `sshKeyPath` parameter
   - Uses `buildSSHCommand()` from precheck.go (same package)

6. **cmd/run.go** - Run command
   - Updated `cleanupRemoteReportFiles()` to use `buildSSHCommand()`

7. **cmd/collect.go** - Collect command
   - Updated `cleanupRemoteFiles()` signature to accept `sshKeyPath`
   - Updated `collectFromHost()` signature to accept `sshKeyPath`
   - Replaced three `exec.Command("ssh")` calls with `buildSSHCommand()`
   - All callers updated to pass `cfg.SSH.PrivateKey`

8. **cmd/stop.go** - Stop command
   - Replaced `exec.Command("ssh")` with `buildSSHCommand()`
   - Uses `cfg.SSH.PrivateKey` for SSH key path

9. **Tests**
   - Created `config/config_ssh_test.go` with SSH configuration tests (3 tests)
   - Created `stream/command_builder_ssh_test.go` with command builder SSH tests (4 tests)
   - All tests passing ✅

10. **Verification**
    - ✅ Full test suite passes: `go test ./...`
    - ✅ Compilation successful: `go build`
    - ✅ No remaining direct SSH calls in codebase (verified with grep)

## Summary

The v0.1.2 SSH private key support implementation is **100% complete**.

### Key Changes

1. **Configuration Layer** ✅
   - Added SSH configuration structure with default value `~/.ssh/id_rsa`
   - All config tests passing

2. **Command Builder Layer** ✅
   - Integrated SSH key parameter into `IBWriteBWCommandBuilder`
   - All command builder tests passing

3. **Stream Generation Layer** ✅
   - Updated all three stream types (incast, p2p, fullmesh)
   - All use `cfg.SSH.PrivateKey` for SSH commands

4. **Command Layer** ✅
   - Created reusable `buildSSHCommand()` helper function
   - Updated all commands: precheck, probe, run, collect, stop
   - All direct `exec.Command("ssh")` calls replaced

5. **Testing** ✅
   - 7 new tests created (3 config + 4 command builder)
   - Full test suite passing: `go test ./...`
   - Compilation successful: `go build`

### Backward Compatibility

All changes maintain backward compatibility:
- If SSH key path is not specified in config, default `~/.ssh/id_rsa` is used
- If SSH key path is empty string, no `-i` parameter is added to SSH commands
- Existing configs without `ssh` section will automatically get the default value

### Usage

Users can now specify custom SSH private key in their config:

```yaml
ssh:
  private_key: "/path/to/custom/id_rsa"
```

The implementation follows area02.md v0.1.2 requirements exactly as specified.
